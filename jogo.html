<canvas width="400" height="700"></canvas>

<script>

	var tela = document.querySelector('canvas');
	var pincel = tela.getContext('2d');
	pincel.fillStyle = 'lightgray';
	pincel.fillRect(0, 0, 400, 500);
	
	var exec = true;  		//jogo em execução ou pausado
	var pos_cir = [20, 20]; //posição do centro do círculo
	var vel = [0.6, 0.6]; 		//velocidade do círculo
	var pos_barra = 0;		//coordenada X do meio da barra
	
	function desenhaBarra(x) {
		if (x < 35) {
			pos_barra = 35;
		}
		if (x > 365) {
			pos_barra = 365;
		}
		var canto = pos_barra - 35;
		pincel.fillStyle = 'darkgray';
		pincel.fillRect(canto, 480, 70, 20);
	}
	
	function desenhaCirculo(coords, raio) {
		pincel.fillStyle = 'blue';
		pincel.beginPath();
		pincel.arc(coords[0], coords[1], raio, 0, 2 * Math.PI);
		pincel.fill();
	}
	
	function limpaTela() {
		pincel.clearRect(0, 0, 400, 480);
		pincel.fillStyle = 'lightgray';
		pincel.fillRect(0, 0, 400, 480);
	}
	
	function limpaTelaInferior() {
		pincel.clearRect(0, 480, 400, 220);
		pincel.fillStyle = 'black';
		pincel.fillRect(0, 480, 400, 20);
	}
	
	function moveBarra (evento) {
		if (exec){
			var x = evento.pageX - tela.offsetLeft;
			pos_barra = x;
			limpaTelaInferior();
			desenhaBarra(pos_barra);
		}
	}
	
	function somaVetorial (v1, v2) {
		if (v1.length == v2.length) {
			var soma = [0];
			//inicializacao do array soma
			for(var i = 1; i < v1.length; i++) {
				soma.push(0);
			}
			//soma vetorial
			for(var i = 0; i < v1.length; i++) {
				soma[i] = v1[i] + v2[i];
			}
			return soma;
		} else {
			exec = false;
			return ["DEU MERDA, VETORES DE TAMANHOS DIFERENTES", "hmmm"];
		}
	}
	
	function atualizaVelocidade (v) {
		if ((pos_cir[0] > 390)||(pos_cir[0] < 10)) {
			v[0] *= -1;
		}
		if ((pos_cir[1] > 470)||(pos_cir[1] < 10)) {
			v[1] *= -1;
		}
		return v;
	}
	
	function detectarColisaoComParedes () {
		var col = false;
		if ((pos_cir[0] > 390)||(pos_cir[0] < 10)) {
			col = true;
		}
		if(pos_cir[1] < 10) {
			col = true;
		}
		return (col);
	}
	
	function detectarColisaoComBarraPrecisa (dif) {
		var col = false;
		if (Math.abs(dif) < 35){
			vel = atualizaVelocidade (vel);
			//console.log(dif);
		} else {
			if (dif > 35) {  //caso 1: círculo a direita da barra
				vel = atualizaVelocidade (vel);
				console.log("direita")
			}
			if (dif < 35) {  //caso 2: círculo a esquerda da barra
				vel = atualizaVelocidade (vel);
				console.log("esquerda")
			}
		}
	}
	
	function detectarColisaoComBarra () {
		var col = false;
		if(pos_cir[1] > 470){
			var dif = (pos_cir[0] - pos_barra);
			if ((dif < 45)&&(dif > (-45))){
				detectarColisaoComBarraPrecisa(dif);
				col = true;
			}
		}
		return col;
	}
	
	function detectarColisao() {
		var col_par = detectarColisaoComParedes();
		if (col_par) {
			vel = atualizaVelocidade (vel);
			console.log("col_par: " + col_par);
		}
		var col_barra = detectarColisaoComBarra();
		if (col_barra) {
			console.log("col_barra: " + col_barra);
		}
	}
	
	function atualizaTela() {
		if (exec) {
			pos_cir = somaVetorial (pos_cir, vel);
			detectarColisao();
			limpaTela();
			desenhaCirculo(pos_cir, 10);
			desenhaBarra(pos_barra);
		}
	}
	
	function pausarResumir (evento) {
		var tecla = evento.which;
		if (tecla == 32){ //tecla 32: espaço
			if (exec == true) {
				exec = false;
				console.log (exec);
			} else {
				exec = true;
				console.log (exec);
			}
		}
	}
	
	tela.onmousemove = moveBarra;
	document.onkeydown = pausarResumir;

	setInterval(atualizaTela, 10);
	limpaTelaInferior();
	
	
</script>